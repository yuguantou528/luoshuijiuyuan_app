<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>告警详情 - 北斗落水救援</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f2f2f7;
            color: #000;
            user-select: none;
        }
        .ios-status-bar {
            height: 48px;
            background-color: #007AFF;
            color: white;
        }
        .bottom-tab {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .detail-card {
            background-color: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 16px;
            overflow: hidden;
        }
        .section-title {
            font-weight: 600;
            font-size: 16px;
            color: #1f2937;
            position: relative;
            padding-left: 12px;
        }
        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 16px;
            background: #007AFF;
            border-radius: 2px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #6b7280;
            font-size: 14px;
        }
        .info-value {
            color: #1f2937;
            font-size: 14px;
            font-weight: 500;
            text-align: right;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        /* 标题中的状态标签样式 */
        h1 .status-badge {
            font-size: 11px;
            padding: 3px 8px;
            vertical-align: middle;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-unrescued {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        .status-rescuing {
            background-color: rgba(249, 115, 22, 0.1);
            color: #f97316;
        }
        .status-rescued {
            background-color: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        .map-container {
            height: 250px;
            background-color: #e5e7eb;
            position: relative;
            overflow: hidden;
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
        }
        #trajectory-map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .alert-marker {
            background-color: #ff3b30;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            animation: pulse 2s infinite;
        }
        .path-marker {
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px !important;
            height: 12px !important;
            margin-left: -6px;
            margin-top: -6px;
        }
        .start-marker {
            background-color: #ef4444;
        }
        .end-marker {
            background-color: #10b981;
        }
        .rescue-button {
            background: linear-gradient(135deg, #0091ff 0%, #0066cc 100%);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
            transition: all 0.2s ease;
        }
        .rescue-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 6px rgba(0, 122, 255, 0.1);
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }
        .tab-button {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            color: #007AFF;
            border-bottom: 2px solid #007AFF;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- iOS 状态栏 -->
    <div class="ios-status-bar flex items-center justify-between px-6">
        <div class="text-sm font-semibold">09:07</div>
        <div class="notch flex space-x-1.5">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-full"></i>
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="flex items-center p-4">
            <a href="alerts.html" class="text-blue-500 mr-4">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-xl font-semibold flex-1 text-center" id="alert-title">
                未救援告警
            </h1>
            <div class="w-6"></div> <!-- 用于平衡左侧返回按钮 -->
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="flex-1 overflow-y-auto pb-20">
        <!-- 告警状态 -->
        <div class="detail-card mx-4 mt-4">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-bold text-lg" id="device-name-display">北斗救生终端 BD-500X</h3>
                    </div>
                    <div class="status-badge status-unrescued" id="rescue-status-badge">
                        <i class="fas fa-exclamation-circle mr-1"></i> 未救援
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-3">
                    <div class="text-sm text-gray-600 font-medium">落水告警时间：</div>
                    <div class="text-sm text-gray-500" id="alert-time">2023-07-12 14:23</div>
                </div>
                
                <div class="flex justify-between items-center mt-2">
                    <div class="text-sm text-gray-600 font-medium">最后告警时间：</div>
                    <div class="text-sm text-gray-500" id="last-alert-time">2023-07-12 14:23</div>
                </div>
                
                <div class="flex justify-between items-center mt-2" id="timer-container">
                    <div class="text-sm text-gray-600 font-medium">已落水时间：</div>
                    <div class="text-lg font-bold text-red-500" id="timer">00:03:42</div>
                </div>
                
                <div class="mt-4" id="rescue-button-container">
                    <button class="rescue-button w-full text-white py-3 px-4 rounded-xl text-sm font-medium" id="rescue-action-button">
                        <i class="fas fa-life-ring mr-1"></i> 结束救援
                    </button>
                </div>
            </div>
        </div>

        <!-- 漂流轨迹地图 -->
        <div class="detail-card mx-4">
            <div class="p-4 pb-2 flex justify-between items-center">
                <h3 class="section-title">漂流轨迹</h3>
                <a href="map.html?alert_id=A2207" class="px-4 py-1.5 bg-white border border-blue-500 text-blue-500 rounded-md text-sm font-medium">
                    <i class="fas fa-map-marked-alt mr-1"></i> 查看地图
                </a>
            </div>
            <div class="map-container">
                <div id="trajectory-map" style="width:100%; height:100%; z-index:1;"></div>
            </div>
        </div>

        <!-- 选项卡 -->
        <div class="bg-white sticky top-[96px] z-10 mx-4 mt-4 rounded-t-lg border-b border-gray-200">
            <div class="flex">
                <button class="tab-button active" id="tab-device" onclick="switchTab('device')">
                    <i class="fas fa-microchip mr-1"></i> 设备信息
                </button>
                <button class="tab-button" id="tab-person" onclick="switchTab('person')">
                    <i class="fas fa-user mr-1"></i> 人员信息
                </button>
                <button class="tab-button" id="tab-trajectory" onclick="switchTab('trajectory')">
                    <i class="fas fa-route mr-1"></i> 轨迹信息
                </button>
            </div>
        </div>

        <!-- 选项卡内容 -->
        <div class="mx-4 mb-4">
            <!-- 设备信息 -->
            <div class="detail-card" id="content-device">
                <div class="p-4">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-life-ring text-blue-500 text-lg"></i>
                        </div>
                        <div class="ml-4">
                            <h4 class="font-semibold" id="device-name">北斗救生终端 BD-500X</h4>
                            <p class="text-xs text-gray-500 mt-1" id="device-status">
                                <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span> 运行正常
                            </p>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-100 pt-3">
                        <div class="info-item">
                            <div class="info-label">设备编号</div>
                            <div class="info-value" id="device-id">BD2301</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">所属公司</div>
                            <div class="info-value" id="device-company">海洋救援有限公司</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">北斗卡号</div>
                            <div class="info-value" id="device-card-number">BD98765432</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">设备电量</div>
                            <div class="info-value" id="device-battery">
                                <div class="flex items-center">
                                    <div class="w-6 h-3 bg-yellow-100 rounded-sm border border-yellow-500 relative mr-1">
                                        <div class="absolute left-0 top-0 bottom-0 bg-yellow-500" style="width: 50%"></div>
                                    </div>
                                    <span class="text-yellow-500">50%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 人员信息 -->
            <div class="detail-card hidden" id="content-person">
                <div class="p-4">
                    <div class="flex mb-4">
                        <img src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&auto=format&fit=crop&q=80" 
                            class="w-20 h-20 rounded-full object-cover border-2 border-blue-500" alt="落水人员照片" id="person-photo">
                        <div class="ml-4 flex-1">
                            <h4 class="font-semibold text-lg" id="person-name">李四</h4>
                            <p class="text-sm text-gray-500 mt-1" id="person-phone">
                                <i class="fas fa-phone mr-1"></i> 13800138000
                            </p>
                            <p class="text-sm text-gray-500 mt-1" id="person-company">
                                <i class="fas fa-building mr-1"></i> 远洋渔业集团
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 轨迹信息 -->
            <div class="detail-card hidden" id="content-trajectory">
                <div class="p-4">
                    <div class="border-b border-gray-100">
                        <div class="info-item">
                            <div class="info-label">起始位置</div>
                            <div class="info-value" id="trajectory-start">东经118.841216°, 北纬26.403032°</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">最后位置</div>
                            <div class="info-value" id="trajectory-current">东经118.843150°, 北纬26.402187°</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">漂流距离</div>
                            <div class="info-value" id="trajectory-distance">235米</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 底部导航栏 -->
    <div class="bottom-tab py-2 px-6 grid grid-cols-4 gap-1 fixed bottom-0 left-0 right-0 max-w-md mx-auto">
        <a href="index.html" class="flex flex-col items-center text-gray-400">
            <i class="fas fa-home text-lg"></i>
            <span class="text-xs mt-1">首页</span>
        </a>
        <a href="map.html" class="flex flex-col items-center text-gray-400">
            <i class="fas fa-map-marked-alt text-lg"></i>
            <span class="text-xs mt-1">地图</span>
        </a>
        <a href="alerts.html" class="flex flex-col items-center text-blue-500">
            <i class="fas fa-exclamation-circle text-lg"></i>
            <span class="text-xs mt-1">告警</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center text-gray-400">
            <i class="fas fa-user text-lg"></i>
            <span class="text-xs mt-1">我的</span>
        </a>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 确保Leaflet库已加载
        if (typeof L === 'undefined') {
            console.error("Leaflet库未加载!");
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"><\/script>');
        } else {
            console.log("Leaflet库已加载");
        }
    </script>
    <script>
        // 获取URL参数函数
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return decodeURIComponent(r[2]); return null;
        }
        
        // 从URL参数获取告警ID和状态
        const urlAlertId = getUrlParam('id');
        const urlAlertStatus = getUrlParam('status');
        
        // 优先使用URL参数，其次使用localStorage
        const currentAlertId = urlAlertId || localStorage.getItem('currentAlertId') || 'A2207';
        const currentAlertStatus = urlAlertStatus || localStorage.getItem('currentAlertStatus') || 'unrescued';
        
        console.log("页面加载，当前告警ID:", currentAlertId);
        console.log("页面加载，当前告警状态:", currentAlertStatus);
        
        // 模拟数据库中的告警数据
        const alertData = {
            'A2207': {
                id: 'A2207',
                time: '2023-07-12 14:23',
                status: 'unrescued', // 默认状态，会被覆盖
                coordinates: {
                    longitude: 118.841216,
                    latitude: 26.403032
                },
                timer: '00:03:42',
                person: {
                    name: '李四',
                    photo: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&auto=format&fit=crop&q=80',
                    phone: '13800138000',
                    company: '远洋渔业集团',
                    rescueStatus: '未救援' // 默认状态，会被覆盖
                },
                device: {
                    id: 'BD2301',
                    name: '北斗救生终端 BD-500X',
                    alertTime: '2023-07-12 14:23',  // 最后告警时间，和初始告警时间一致
                    company: '海洋救援有限公司',
                    cardNumber: 'BD98765432',
                    battery: '50%'
                },
                trajectory: {
                    start: '东经118.841216°, 北纬26.403032°',
                    current: '东经118.843150°, 北纬26.402187°',
                    distance: '235米',
                    time: '00:03:42',
                    speed: '1.05 m/s',
                    direction: '东南',
                    points: [
                        {
                            time: "14:22:05",
                            label: "告警点",
                            latitude: 26.403032,
                            longitude: 118.841216,
                            color: "bg-red-500"
                        },
                        {
                            time: "14:34:18",
                            label: "漂流点 1",
                            latitude: 26.402158,
                            longitude: 118.843521,
                            color: "bg-orange-500"
                        },
                        {
                            time: "14:46:22",
                            label: "漂流点 2",
                            latitude: 26.401345,
                            longitude: 118.845732,
                            color: "bg-yellow-500"
                        },
                        {
                            time: "14:57:32",
                            label: "当前位置",
                            latitude: 26.400321,
                            longitude: 118.847916,
                            color: "bg-blue-500"
                        }
                    ]
                }
            },
            'A2205': {
                id: 'A2205',
                time: '2023-07-11 16:42',
                status: 'rescued',
                coordinates: {
                    longitude: 118.823451,
                    latitude: 26.394582
                },
                timer: '00:23:42',
                person: {
                    name: '王五',
                    photo: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=150&auto=format&fit=crop&q=80',
                    phone: '13923456789',
                    company: '东方渔业有限公司',
                    rescueStatus: '已救援'
                },
                device: {
                    id: 'BD2303',
                    alertTime: '2025-07-10 14:57:39',
                    company: '北斗海事科技公司',
                    cardNumber: 'BD34567890',
                    battery: '20%'
                },
                trajectory: {
                    start: '东经118.823451°, 北纬26.394582°',
                    current: '东经118.825789°, 北纬26.393471°',
                    distance: '287米',
                    time: '00:23:42',
                    speed: '0.83 m/s',
                    direction: '东南',
                    points: [
                        {
                            time: "14:57:39",
                            label: "告警点",
                            latitude: 26.398173,
                            longitude: 118.852647,
                            color: "bg-red-500"
                        },
                        {
                            time: "15:01:20",
                            label: "当前位置",
                            latitude: 26.397982,
                            longitude: 118.853421,
                            color: "bg-blue-500"
                        }
                    ]
                }
            }
        };
        
        // 获取或创建当前告警数据
        let currentAlert;
        if (alertData[currentAlertId]) {
            currentAlert = alertData[currentAlertId];
            // 强制使用传入的状态
            currentAlert.status = currentAlertStatus;
            currentAlert.person.rescueStatus = currentAlertStatus === 'rescued' ? '已救援' : '未救援';
        } else {
            // 如果找不到告警数据，使用默认数据
            currentAlert = alertData['A2207'];
            currentAlert.status = currentAlertStatus;
            currentAlert.person.rescueStatus = currentAlertStatus === 'rescued' ? '已救援' : '未救援';
        }

        // 页面加载完成后执行初始化
        window.onload = function() {
            console.log("页面完全加载，初始化页面");
            
            // 如果是已救援状态，重定向到已救援详情页面
            if (currentAlertStatus === 'rescued') {
                console.log("当前是已救援状态，重定向到已救援详情页面");
                window.location.href = 'rescued-alert-details.html?id=' + currentAlertId + '&status=rescued&t=' + new Date().getTime();
                return;
            }
            
            // 初始化页面数据
            initializePageData();
            
            // 绑定救援按钮点击事件
            bindRescueButtonClick();
            
            // 确保地图容器存在
            const mapContainer = document.getElementById('trajectory-map');
            if (mapContainer) {
                console.log("地图容器存在，尺寸:", mapContainer.offsetWidth, "x", mapContainer.offsetHeight);
                
                // 强制重新生成轨迹
                setTimeout(function() {
                    console.log("延迟执行地图初始化");
                    generateTrajectory();
                }, 500);
            } else {
                console.error("找不到地图容器!");
            }
        };
        
        // 绑定救援按钮点击事件
        function bindRescueButtonClick() {
            const rescueButton = document.getElementById('rescue-action-button');
            if (!rescueButton) {
                console.error("找不到救援按钮!");
                return;
            }
            
            // 直接使用onclick属性绑定
            rescueButton.onclick = function() {
                console.log("救援按钮被点击");
                
                // 使用原生JavaScript的confirm函数
                var result = confirm('确定要结束救援吗？');
                console.log("确认结果:", result);
                
                if (result === true) {
                    console.log("用户确认结束救援");
                    
                    // 更新状态
                    currentAlert.status = 'rescued';
                    localStorage.setItem('currentAlertStatus', 'rescued');
                    
                    // 跳转到已救援详情页面
                    window.location.href = 'rescued-alert-details.html?id=' + currentAlertId + '&status=rescued&t=' + new Date().getTime();
                }
                
                // 阻止事件冒泡和默认行为
                return false;
            };
            
            console.log("救援按钮事件已绑定");
        }
        
        // 切换标签页
        function switchTab(tabName) {
            // 移除所有标签页的激活状态
            document.getElementById('tab-person').classList.remove('active');
            document.getElementById('tab-device').classList.remove('active');
            document.getElementById('tab-trajectory').classList.remove('active');
            
            // 隐藏所有内容
            document.getElementById('content-person').classList.add('hidden');
            document.getElementById('content-device').classList.add('hidden');
            document.getElementById('content-trajectory').classList.add('hidden');
            
            // 激活选中的标签页
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('content-' + tabName).classList.remove('hidden');
        }
        
        // 初始化页面数据
        function initializePageData() {
            console.log("初始化页面数据，当前告警状态:", currentAlert.status);
            
            // 更新页面标题和设备名称
            document.getElementById('alert-title').textContent = `未救援告警`;
            document.getElementById('device-name-display').textContent = currentAlert.device && currentAlert.device.name 
                ? currentAlert.device.name : '北斗救生终端 BD-500X';
            document.getElementById('alert-time').textContent = currentAlert.time;
            
            // 更新最后告警时间（与告警时间相同或使用设备中的时间）
            const lastAlertTime = currentAlert.device && currentAlert.device.alertTime 
                ? currentAlert.device.alertTime 
                : currentAlert.time;
            document.getElementById('last-alert-time').textContent = lastAlertTime;
            
            // 更新计时器
            document.getElementById('timer').textContent = currentAlert.timer;
            
            // 更新状态显示
            updateStatusDisplay(currentAlert.status);
            
            // 更新设备信息
            updateDeviceInfo();
            
            // 更新人员信息
            updatePersonInfo();
            
            // 更新地图链接
            updateMapLink();
            
            // 更新轨迹信息
            updateTrajectoryInfo();
            
            // 生成并显示漂流轨迹
            generateTrajectory();
            
            // 默认显示设备信息标签页
            switchTab('device');
        }
        
        // 更新状态显示
        function updateStatusDisplay(status) {
            const statusBadge = document.getElementById('status-badge');
            const rescueStatusBadge = document.getElementById('rescue-status-badge');
            const rescueButton = document.getElementById('rescue-action-button');
            const timerContainer = document.getElementById('timer-container');
            const timer = document.getElementById('timer');
            
            console.log("更新状态显示:", status);
            
            if (status === 'unrescued') {
                // 未救援状态
                statusBadge.className = 'status-badge status-unrescued ml-2 text-sm';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> 未救援';
                
                rescueStatusBadge.className = 'status-badge status-unrescued';
                rescueStatusBadge.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> 未救援';
                
                // 设置救援结束按钮
                rescueButton.innerHTML = '<i class="fas fa-life-ring mr-1"></i> 结束救援';
                rescueButton.className = 'rescue-button w-full text-white py-3 px-4 rounded-xl text-sm font-medium';
                
                // 未救援状态下，显示已落水时间
                timerContainer.firstElementChild.textContent = '已落水时间：';
                timer.className = 'text-lg font-bold text-red-500';
                
            } else if (status === 'rescuing') {
                // 救援中状态
                statusBadge.className = 'status-badge status-rescuing ml-2 text-sm';
                statusBadge.innerHTML = '<i class="fas fa-running mr-1"></i> 救援中';
                
                rescueStatusBadge.className = 'status-badge status-rescuing';
                rescueStatusBadge.innerHTML = '<i class="fas fa-running mr-1"></i> 救援中';
                
                // 设置救援结束按钮
                rescueButton.innerHTML = '<i class="fas fa-check-circle mr-1"></i> 完成救援';
                rescueButton.className = 'rescue-button w-full text-white py-3 px-4 rounded-xl text-sm font-medium';
                
                timerContainer.firstElementChild.textContent = '已落水时间：';
                timer.className = 'text-lg font-bold text-red-500';
                
            } else if (status === 'rescued') {
                // 已救援状态将重定向到已救援页面，这里不做处理
            }
        }
        
        // 更新人员信息
        function updatePersonInfo() {
            if (currentAlert.person) {
                document.getElementById('person-photo').src = currentAlert.person.photo;
                document.getElementById('person-name').textContent = currentAlert.person.name;
                document.getElementById('person-phone').innerHTML = `<i class="fas fa-phone mr-1"></i> ${currentAlert.person.phone}`;
                document.getElementById('person-company').innerHTML = `<i class="fas fa-building mr-1"></i> ${currentAlert.person.company}`;
            }
        }
        
        // 更新设备信息
        function updateDeviceInfo() {
            if (currentAlert.device) {
                document.getElementById('device-name').textContent = '北斗救生终端 BD-500X';
                const deviceStatusEl = document.getElementById('device-status');
                deviceStatusEl.innerHTML = '<span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span> 运行正常';
                
                document.getElementById('device-id').textContent = currentAlert.device.id;
                document.getElementById('device-alert-time').textContent = currentAlert.device.alertTime;
                document.getElementById('device-company').textContent = currentAlert.device.company;
                document.getElementById('device-card-number').textContent = currentAlert.device.cardNumber;
                
                // 设置电池图标
                updateBatteryDisplay();
            }
        }
        
        // 更新电池显示
        function updateBatteryDisplay() {
            const batteryPercentage = parseInt(currentAlert.device.battery);
            const batteryContainer = document.getElementById('device-battery');
            
            if (batteryPercentage <= 20) {
                batteryContainer.innerHTML = `<div class="flex items-center">
                    <div class="w-6 h-3 bg-red-100 rounded-sm border border-red-500 relative mr-1">
                        <div class="absolute left-0 top-0 bottom-0 bg-red-500" style="width: ${batteryPercentage}%"></div>
                    </div>
                    <span class="text-red-500">${currentAlert.device.battery}</span>
                </div>`;
            } else if (batteryPercentage <= 50) {
                batteryContainer.innerHTML = `<div class="flex items-center">
                    <div class="w-6 h-3 bg-yellow-100 rounded-sm border border-yellow-500 relative mr-1">
                        <div class="absolute left-0 top-0 bottom-0 bg-yellow-500" style="width: ${batteryPercentage}%"></div>
                    </div>
                    <span class="text-yellow-500">${currentAlert.device.battery}</span>
                </div>`;
            } else {
                batteryContainer.innerHTML = `<div class="flex items-center">
                    <div class="w-6 h-3 bg-green-100 rounded-sm border border-green-500 relative mr-1">
                        <div class="absolute left-0 top-0 bottom-0 bg-green-500" style="width: ${batteryPercentage}%"></div>
                    </div>
                    <span class="text-green-500">${currentAlert.device.battery}</span>
                </div>`;
            }
        }
        
        // 初始化漂流轨迹地图
        function generateTrajectory() {
            const centerLong = currentAlert.coordinates.longitude;
            const centerLat = currentAlert.coordinates.latitude;
            
            // 如果有轨迹点数据，使用它
            if (currentAlert.trajectory.points && currentAlert.trajectory.points.length > 0) {
                drawTrajectoryFromPoints(document.getElementById('trajectory-map'), currentAlert.trajectory.points);
            } else {
                // 否则生成随机轨迹点
                let points = [];
                
                // 起始点
                points.push({
                    longitude: centerLong,
                    latitude: centerLat,
                    isStart: true,
                    isCurrent: false
                });
                
                // 生成随机漂流点
                const pointCount = currentAlert.status === 'unrescued' ? 5 : 10;
                for (let i = 1; i < pointCount; i++) {
                    // 模拟海流漂移，通常是一个方向为主
                    const longOffset = (Math.random() * 0.005 - 0.002) + (0.001 * i); // 总体向东漂移
                    const latOffset = (Math.random() * 0.004 - 0.002) - (0.0005 * i); // 总体向南漂移
                    
                    points.push({
                        longitude: centerLong + longOffset,
                        latitude: centerLat + latOffset,
                        isStart: false,
                        isCurrent: i === pointCount - 1 // 最后一个点为当前位置
                    });
                }
                
                drawTrajectory(document.getElementById('trajectory-map'), points);
            }
            
            // 如果是未救援状态，开始实时更新
            if (currentAlert.status === 'unrescued') {
                startRealtimeUpdate(currentAlert.trajectory.points || []);
            }
        }
        
        // 从轨迹点数据绘制轨迹
        function drawTrajectoryFromPoints(mapContainer, points) {
            if (!mapContainer) {
                console.error("地图容器不存在!");
                return;
            }
            
            console.log("开始绘制轨迹，点数:", points.length);
            
            try {
                // 检查之前的地图实例，如果存在则销毁
                if (window.trajectoryMap && window.trajectoryMap.remove) {
                    console.log("移除现有地图实例");
                    window.trajectoryMap.remove();
                }
                
                // 创建Leaflet地图实例
                window.trajectoryMap = L.map(mapContainer.id, {
                    center: [points[0].latitude, points[0].longitude], // 初始化中心点
                    zoom: 15, // 初始缩放级别
                    zoomControl: false, // 移除默认缩放控件
                    attributionControl: false // 移除默认版权信息
                });
                
                console.log("地图实例创建成功");
                
                // 尝试加载主要地图源
                const mainTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                });
                
                // 备用地图源
                const backupTileLayer = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG21Xc', {
                    maxZoom: 19
                });
                
                // 先尝试加载主要地图源
                mainTileLayer.addTo(window.trajectoryMap);
                
                // 地图加载错误时使用备用源
                mainTileLayer.on('tileerror', function() {
                    console.log("主要地图源加载失败，使用备用地图源");
                    if (!window.backupTileLayerAdded) {
                        backupTileLayer.addTo(window.trajectoryMap);
                        window.backupTileLayerAdded = true;
                    }
                });
                
                console.log("地图底图添加成功");
    
                // 添加告警点
                const alertMarker = L.marker([points[0].latitude, points[0].longitude], {
                    icon: L.divIcon({
                        className: 'alert-marker start-marker',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(window.trajectoryMap);
    
                // 收集所有点的坐标用于绘制轨迹线
                const pathCoordinates = points.map(point => [point.latitude, point.longitude]);
                
                // 绘制轨迹线
                const pathLine = L.polyline(pathCoordinates, {
                    color: '#3b82f6', // 漂流轨迹颜色
                    weight: 3,
                    opacity: 0.7
                }).addTo(window.trajectoryMap);
    
                // 添加漂流点
                for (let i = 1; i < points.length; i++) {
                    const point = points[i];
                    L.marker([point.latitude, point.longitude], {
                        icon: L.divIcon({
                            className: 'path-marker',
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).addTo(window.trajectoryMap);
                }
    
                // 添加当前位置点
                const currentPoint = points[points.length - 1];
                const currentMarker = L.marker([currentPoint.latitude, currentPoint.longitude], {
                    icon: L.divIcon({
                        className: 'path-marker end-marker',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(window.trajectoryMap);
    
                // 调整地图缩放以适应所有点
                window.trajectoryMap.fitBounds(pathLine.getBounds(), {padding: [30, 30]});
                
                console.log("轨迹绘制完成");
                
                // 触发地图重绘
                setTimeout(function() {
                    window.trajectoryMap.invalidateSize();
                    console.log("地图大小重新计算");
                }, 100);
            } catch (error) {
                console.error("地图初始化错误:", error);
            }
        }
        
        // 绘制轨迹
        function drawTrajectory(mapContainer, points) {
            if (!mapContainer) {
                console.error("地图容器不存在!");
                return;
            }
            
            console.log("开始绘制轨迹，点数:", points.length);
            
            // 创建Leaflet地图实例
            const map = L.map(mapContainer.id, {
                center: [points[0].latitude, points[0].longitude], // 初始化中心点
                zoom: 15, // 初始缩放级别
                zoomControl: false, // 移除默认缩放控件
                attributionControl: false // 移除默认版权信息
            });

            // 添加底图
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            // 添加告警点
            const alertMarker = L.marker([points[0].latitude, points[0].longitude], {
                icon: L.divIcon({
                    className: 'alert-marker start-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(map);

            // 收集所有点的坐标用于绘制轨迹线
            const pathCoordinates = points.map(point => [point.latitude, point.longitude]);
            
            // 绘制轨迹线
            const pathLine = L.polyline(pathCoordinates, {
                color: '#3b82f6', // 漂流轨迹颜色
                weight: 3,
                opacity: 0.7
            }).addTo(map);

            // 添加漂流点
            for (let i = 1; i < points.length; i++) {
                const point = points[i];
                L.marker([point.latitude, point.longitude], {
                    icon: L.divIcon({
                        className: 'path-marker',
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    })
                }).addTo(map);
            }

            // 添加当前位置点
            const currentPoint = points[points.length - 1];
            const currentMarker = L.marker([currentPoint.latitude, currentPoint.longitude], {
                icon: L.divIcon({
                    className: 'path-marker end-marker',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map);

            // 调整地图缩放以适应所有点
            map.fitBounds(pathLine.getBounds(), {padding: [30, 30]});
            
            console.log("轨迹绘制完成");
        }
        
        // 实时更新轨迹
        function startRealtimeUpdate(initialPoints) {
            // 只有在未救援状态下才更新
            if (currentAlert.status !== 'unrescued') return;
            
            setTimeout(() => {
                const mapContainer = document.getElementById('trajectory-map');
                
                // 添加新的漂流点
                const lastPoint = initialPoints[initialPoints.length - 1];
                const newPoint = {
                    longitude: lastPoint.longitude + (Math.random() * 0.001 - 0.0005),
                    latitude: lastPoint.latitude + (Math.random() * 0.001 - 0.0005),
                    isStart: false,
                    isCurrent: true
                };
                
                // 更新最后一个点为非当前点
                initialPoints[initialPoints.length - 1].isCurrent = false;
                initialPoints.push(newPoint);
                
                // 重新绘制轨迹
                drawTrajectory(mapContainer, initialPoints);
                
                // 继续更新
                startRealtimeUpdate(initialPoints);
            }, 5000); // 每5秒更新一次
        }
        
        // 更新地图链接
        function updateMapLink() {
            const mapLink = document.querySelector('a[href^="map.html"]');
            if (mapLink) {
                mapLink.href = `map.html?alert_id=${currentAlert.id}`;
                console.log("更新地图链接:", mapLink.href);
            }
        }

        // 更新轨迹信息
        function updateTrajectoryInfo() {
            if (currentAlert.trajectory) {
                    // 更新起始位置、最后位置和漂流距离
                document.getElementById('trajectory-start').textContent = currentAlert.trajectory.start || '东经118.841216°, 北纬26.403032°';
                document.getElementById('trajectory-current').textContent = currentAlert.trajectory.current || '东经118.843150°, 北纬26.402187°';
                document.getElementById('trajectory-distance').textContent = currentAlert.trajectory.distance || '235米';
            }
        }
    </script>
</body>
</html> 